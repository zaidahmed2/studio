'use server';

/**
 * @fileOverview A chat flow that responds to user input based on specific rules.
 *
 * - chat - A function that handles the chat logic.
 * - ChatInput - The input type for the chat function.
 * - ChatOutput - The return type for the chat function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const ChatInputSchema = z.object({
  message: z.string().describe('The user message.'),
});
export type ChatInput = z.infer<typeof ChatInputSchema>;

const ChatOutputSchema = z.object({
  response: z.string().describe('The AI response.'),
});
export type ChatOutput = z.infer<typeof ChatOutputSchema>;

export async function chat(input: ChatInput): Promise<ChatOutput> {
  return chatFlow(input);
}

const prompt = ai.definePrompt({
  name: 'chatPrompt',
  input: {schema: ChatInputSchema},
  output: {schema: ChatOutputSchema},
  prompt: `You are a chatbot that follows one of two rules and nothing else.
Rule 1: If the user's message is exactly 'hey', case-insensitive, you MUST reply with 'hey'.
Rule 2: For ALL other messages, you MUST reply with 'stay calm baby'.
Do not add any other words or punctuation.

User message: {{{message}}}
`,
});

const chatFlow = ai.defineFlow(
  {
    name: 'chatFlow',
    inputSchema: ChatInputSchema,
    outputSchema: ChatOutputSchema,
  },
  async (input) => {
    const maxRetries = 3;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const { output } = await prompt(input);
        if (!output) {
          throw new Error('No output from AI model.');
        }
        return output;
      } catch (error) {
        if (error instanceof Error && error.message.includes('503') && attempt < maxRetries) {
          console.log(`Attempt ${attempt} failed with 503. Retrying in ${attempt}s...`);
          await new Promise(res => setTimeout(res, 1000 * attempt));
          continue;
        }
        // On last attempt or for non-503 errors, throw the error
        throw error;
      }
    }
    // This line is technically unreachable but satisfies TypeScript that the function
    // always returns a value or throws.
    throw new Error('Chat flow failed after all retries.');
  }
);
